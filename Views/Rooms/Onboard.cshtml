@model BookingVM;

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Management | Cosy Commune</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 text-slate-900 min-h-screen">

<div class="max-w-5xl mx-auto px-4 py-10">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-2xl font-bold text-indigo-950">New Booking</h1>
        </div>
    </div>

    <!-- Multi-Step Progress Tracker -->
    <div class="mb-10 relative px-4">
        <div class="flex justify-between relative z-10">
            <div class="step-indicator flex flex-col items-center" data-step="1">
                <div class="w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold ring-4 ring-white shadow-md transition-colors text-sm">1</div>
                <span class="text-[10px] mt-2 font-bold uppercase tracking-tight text-indigo-600">Room</span>
            </div>
            <div class="step-indicator flex flex-col items-center" data-step="2">
                <div class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold ring-4 ring-white transition-colors text-sm">2</div>
                <span class="text-[10px] mt-2 font-bold uppercase tracking-tight text-gray-400">Stay</span>
            </div>
            <div class="step-indicator flex flex-col items-center" data-step="3">
                <div class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold ring-4 ring-white transition-colors text-sm">3</div>
                <span class="text-[10px] mt-2 font-bold uppercase tracking-tight text-gray-400">Client</span>
            </div>
            <div class="step-indicator flex flex-col items-center" data-step="4">
                <div class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold ring-4 ring-white transition-colors text-sm">4</div>
                <span class="text-[10px] mt-2 font-bold uppercase tracking-tight text-gray-400">Legal</span>
            </div>
            <div class="step-indicator flex flex-col items-center" data-step="5">
                <div class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold ring-4 ring-white transition-colors text-sm">5</div>
                <span class="text-[10px] mt-2 font-bold uppercase tracking-tight text-gray-400">Payment</span>
            </div>
        </div>
        <div class="absolute top-5 left-8 right-8 h-0.5 bg-gray-200 -z-0">
            <div id="progress-line" class="bg-indigo-600 h-full w-0 transition-all duration-500"></div>
        </div>
    </div>

    <!-- Wizard Content -->
    <form asp-action="BookUnit" id="bookingForm" method="post" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        
        <!-- STEP 1: Pick Room -->
        <div class="step-panel active p-8" id="step1">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-door-open text-indigo-600"></i> Select Available Room
                </h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                @foreach(var unit in Model.Rooms){
                    <label class="relative block group cursor-pointer">
                    <input type="radio" name="unit" value="101" class="peer absolute opacity-0" checked>
                    <div class="p-5 border-2 border-slate-100 rounded-xl peer-checked:border-indigo-600 peer-checked:bg-indigo-50/50 transition-all">
                        <span class="font-bold text-lg">Room @unit.RoomNumber</span>
                        <p class="text-sm text-slate-500">Type: @unit.RoomType</p>
                        <p class="text-sm text-slate-500">Capacity: @unit.Capacity</p>
                        <div class="mt-4 flex items-center justify-between">
                            @if(!unit.IsOccupied){
                                <span class="text-indigo-700 font-bold">Available</span>
                            }
                            <i class="fa-solid fa-circle-check text-indigo-600 opacity-0 peer-checked:opacity-100"></i>
                        </div>
                    </div>

                    <a asp-route-id="@unit.Id" type="hidden"></a>
                </label>
                }
            </div>
        </div>

        <!-- STEP 2: Choose Period -->
        <div class="step-panel p-8" id="step2">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                <i class="fa-solid fa-calendar-day text-indigo-600"></i> Choose Stay Period
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <label class="stay-card relative p-6 border-2 border-slate-100 rounded-2xl cursor-pointer hover:border-indigo-200 group">
                    <input type="radio" name="stayType" value="short" class="peer absolute opacity-0" checked onchange="toggleStayContext()">
                    <div class="peer-checked:text-indigo-600 transition-colors">
                        <div class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center mb-4 group-hover:bg-indigo-100 transition-colors">
                            <i class="fa-solid fa-clock text-xl"></i>
                        </div>
                        <h3 class="font-bold text-lg">Short Stay</h3>
                        <p class="text-sm text-slate-500 mt-1">Daily rates. Best for visits &lt; 30 days.</p>
                        <div class="mt-4 pt-4 border-t border-slate-50 opacity-0 peer-checked:opacity-100">
                             <input type="number" id="nightsInput" value="3" placeholder="Number of nights" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                </label>

                <label class="stay-card relative p-6 border-2 border-slate-100 rounded-2xl cursor-pointer hover:border-indigo-200 group">
                    <input type="radio" name="stayType" value="long" class="peer absolute opacity-0" onchange="toggleStayContext()">
                    <div class="peer-checked:text-indigo-600 transition-colors">
                        <div class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center mb-4 group-hover:bg-indigo-100 transition-colors">
                            <i class="fa-solid fa-house-user text-xl"></i>
                        </div>
                        <h3 class="font-bold text-lg">Long-Term Lease</h3>
                        <p class="text-sm text-slate-500 mt-1">Monthly rates. 6+ months commitment.</p>
                        <div class="mt-4 pt-4 border-t border-slate-50 opacity-0 peer-checked:opacity-100">
                             <select id="leaseDuration" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500">
                                 <option value="6">6 Months</option>
                                 <option value="12">12 Months</option>
                             </select>
                        </div>
                    </div>
                </label>
            </div>
        </div>

        <!-- STEP 3: Client Details -->
        <div class="step-panel p-8" id="step3">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                <i class="fa-solid fa-id-card text-indigo-600"></i> Capture Client Details
            </h2>
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Full Legal Name</label>
                    <input type="text" id="firstName" required class="w-full border border-slate-200 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">ID / Passport Number</label>
                    <input type="text" class="w-full border border-slate-200 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Email Address</label>
                    <input type="email" id="email" required class="w-full border border-slate-200 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
        </div>

        <!-- STEP 4: Legal / Signature -->
        <div class="step-panel p-8" id="step4">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                <i class="fa-solid fa-file-signature text-indigo-600"></i> Legal Acceptance
            </h2>
            
            <div id="legalAgreementBox" class="bg-slate-50 border rounded-xl p-5 text-xs text-slate-600 h-32 overflow-y-auto mb-6 leading-relaxed shadow-inner">
                <p class="font-bold mb-2 uppercase">Agreement Terms</p>
                <div id="legalTextContent">
                    <!-- Dynamic Legal Text -->
                </div>
            </div>
            
            <div class="flex flex-col items-center">
                <canvas id="signature-canvas" class="bg-white rounded-xl shadow-inner mb-2"></canvas>
                <div class="flex justify-between w-full">
                    <p class="text-[10px] text-slate-400 font-medium uppercase tracking-wider">Tenant Signature Required</p>
                    <button type="button" onclick="clearSignature()" class="text-xs font-bold text-red-500 hover:text-red-700 uppercase">Clear</button>
                </div>
            </div>
        </div>

        <!-- STEP 5: Payment -->
        <div class="step-panel p-8" id="step5">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                <i class="fa-solid fa-credit-card text-indigo-600"></i> Payment & Billing
            </h2>
            
            <div id="paymentSummary">
                <!-- Injected via setupPaymentStep() -->
            </div>

            <div class="mt-8 space-y-4">
                <h4 class="text-sm font-bold text-slate-700 uppercase tracking-wider">Payment Method Verification</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label class="flex items-center gap-4 p-4 border rounded-xl cursor-pointer hover:bg-slate-50 transition">
                        <input type="radio" name="payMethod" value="eft" checked class="w-4 h-4 text-indigo-600">
                        <div>
                            <p class="font-bold text-sm">Manual EFT / Cash</p>
                            <p class="text-xs text-slate-500">Manager to verify proof of payment</p>
                        </div>
                    </label>
                    <label class="flex items-center gap-4 p-4 border rounded-xl cursor-pointer hover:bg-slate-50 transition">
                        <input type="radio" name="payMethod" value="card" class="w-4 h-4 text-indigo-600">
                        <div>
                            <p class="font-bold text-sm">Credit/Debit Card</p>
                            <p class="text-xs text-slate-500">Processed via internal card terminal</p>
                        </div>
                    </label>
                </div>
            </div>
        </div>

        <!-- Action Footer -->
        <div class="bg-slate-50 px-8 py-5 border-t border-slate-200 flex justify-between">
            <button type="button" id="prevBtn" onclick="changeStep(-1)" class="px-6 py-2.5 rounded-lg font-bold text-slate-500 hover:text-slate-800 transition-colors invisible">Back</button>
            <button type="submit" id="nextBtn" onclick="changeStep(1)" class="bg-indigo-600 text-white px-8 py-2.5 rounded-lg font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all flex items-center gap-2">
                Continue <i class="fa-solid fa-arrow-right text-sm"></i>
            </button>
        </div>
    </form>
</div>

<!-- Completion Modal -->
<div id="completionModal" class="fixed inset-0 bg-slate-950/40 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-3xl p-10 max-w-md w-full text-center shadow-2xl">
        <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl">
            <i class="fa-solid fa-check-double"></i>
        </div>
        <h3 class="text-2xl font-bold text-slate-900 mb-2">Booking Finalized</h3>
        <p class="text-slate-500 mb-8 leading-relaxed">Profile created and transaction recorded. Documentation sent to <strong id="sentEmail" class="text-slate-800">...</strong>.</p>
        <button onclick="window.location.reload()" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold hover:bg-slate-800 transition">Complete & Exit</button>
    </div>
</div>

<script>
    let currentStep = 1;
    const totalSteps = 5;

    function changeStep(n) {
        const panels = document.querySelectorAll('.step-panel');
        
        // Validations
        if (n === 1) {
            if (currentStep === 3) {
                if (!document.getElementById('firstName').value || !document.getElementById('email').value) {
                    alert("Please capture basic client details.");
                    return;
                }
            }
        }

        // Setup Logic for Step Context
        if (n === 1 && currentStep === 3) {
            setupLegalStep();
        }
        if (n === 1 && currentStep === 4) {
            setupPaymentStep();
        }

        panels[currentStep - 1].classList.remove('active');
        currentStep += n;

        if (currentStep > totalSteps) {
            finalizeBooking();
            return;
        }

        panels[currentStep - 1].classList.add('active');
        updateUI();
        
        // Refresh canvas on entering legal step
        if (currentStep === 4) {
            setTimeout(setupCanvas, 100);
        }
    }

    function toggleStayContext() {
        // Function called when stay type changes - visuals handled by CSS peers
        console.log("Stay mode toggled");
    }

    function setupLegalStep() {
        const stayType = document.querySelector('input[name="stayType"]:checked').value;
        const textContainer = document.getElementById('legalTextContent');
        
        if (stayType === 'long') {
            textContainer.innerHTML = `
                <p class="mb-2"><strong>Lease Period:</strong> Monthly renewal with fixed term. Minimum 6 months required.</p>
                <p class="mb-2"><strong>Notice:</strong> One calendar month written notice for termination.</p>
                <p><strong>Damage Deposit:</strong> Equivalent to one month's rent held in trust.</p>
            `;
        } else {
            textContainer.innerHTML = `
                <p class="mb-2"><strong>Short Stay:</strong> Daily occupancy. Non-transferable.</p>
                <p class="mb-2"><strong>Check-out:</strong> Strictly 10:00 AM on departure day.</p>
                <p><strong>Liability:</strong> Client is responsible for any damage to furniture or equipment.</p>
            `;
        }
    }

    function setupPaymentStep() {
        const stayType = document.querySelector('input[name="stayType"]:checked').value;
        const paymentContainer = document.getElementById('paymentSummary');
        
        if (stayType === 'long') {
            paymentContainer.innerHTML = `
                <div class="bg-indigo-900 text-white rounded-2xl p-6 shadow-xl">
                    <div class="flex justify-between items-center mb-4 border-b border-indigo-800 pb-4">
                        <div>
                            <p class="text-xs text-indigo-300 font-bold uppercase tracking-widest">Description</p>
                            <p class="font-medium text-lg">Initial Lease Invoice</p>
                        </div>
                        <div class="text-right">
                            <span class="bg-indigo-700 text-[10px] px-2 py-1 rounded-md font-bold uppercase">Recurring</span>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="opacity-70">Security Deposit (1 Month)</span>
                            <span class="font-bold">R 7,500.00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="opacity-70">First Month Pro-Rata Rent</span>
                            <span class="font-bold">R 7,500.00</span>
                        </div>
                        <div class="pt-4 border-t border-indigo-800 flex justify-between items-center">
                            <span class="text-lg">Total Due Now</span>
                            <span class="text-3xl font-black">R 15,000.00</span>
                        </div>
                    </div>
                </div>
            `;
        } else {
            const nights = document.getElementById('nightsInput').value || 1;
            const total = nights * 550;
            paymentContainer.innerHTML = `
                <div class="bg-indigo-600 text-white rounded-2xl p-6 shadow-xl">
                    <div class="flex justify-between items-center mb-4 border-b border-indigo-500 pb-4">
                        <div>
                            <p class="text-xs text-indigo-200 font-bold uppercase tracking-widest">Description</p>
                            <p class="font-medium text-lg">Short Stay Reservation</p>
                        </div>
                        <div class="text-right">
                            <span class="bg-indigo-500 text-[10px] px-2 py-1 rounded-md font-bold uppercase">Once-off</span>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="opacity-70">Daily Rate (R550.00 Ã— ${nights})</span>
                            <span class="font-bold">R ${total.toLocaleString()}.00</span>
                        </div>
                        <div class="pt-4 border-t border-indigo-500 flex justify-between items-center">
                            <span class="text-lg">Amount Payable</span>
                            <span class="text-3xl font-black">R ${total.toLocaleString()}.00</span>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    function updateUI() {
        const indicators = document.querySelectorAll('.step-indicator');
        const progressLine = document.getElementById('progress-line');
        
        indicators.forEach((ind, idx) => {
            const stepNum = idx + 1;
            const icon = ind.querySelector('div');
            const text = ind.querySelector('span');

            if (stepNum < currentStep) {
                icon.className = 'w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold ring-4 ring-white shadow-md transition-colors text-sm';
                icon.innerHTML = '<i class="fa-solid fa-check"></i>';
                text.className = 'text-[10px] mt-2 font-bold uppercase tracking-tight text-green-600';
            } else if (stepNum === currentStep) {
                icon.className = 'w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold ring-4 ring-white shadow-md transition-colors text-sm';
                icon.innerText = stepNum;
                text.className = 'text-[10px] mt-2 font-bold uppercase tracking-tight text-indigo-600';
            } else {
                icon.className = 'w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold ring-4 ring-white transition-colors text-sm';
                icon.innerText = stepNum;
                text.className = 'text-[10px] mt-2 font-bold uppercase tracking-tight text-gray-400';
            }
        });

        progressLine.style.width = `${((currentStep - 1) / (totalSteps - 1)) * 100}%`;

        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        prevBtn.style.visibility = currentStep === 1 ? 'hidden' : 'visible';
        nextBtn.innerHTML = currentStep === totalSteps 
            ? 'Confirm & Finalize <i class="fa-solid fa-check text-sm"></i>' 
            : 'Continue <i class="fa-solid fa-arrow-right text-sm"></i>';
    }

    // Signature Logic
    const canvas = document.getElementById('signature-canvas');
    let ctx = null;
    let drawing = false;

    function setupCanvas() {
        if (!canvas) return;
        ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = 180;
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#1e1b4b';
    }

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function startDrawing(e) { 
        drawing = true; 
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
    }
    
    function stopDrawing() { drawing = false; }
    function draw(e) {
        if (!drawing) return;
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
    }

    function clearSignature() {
        if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function finalizeBooking() {
        const email = document.getElementById('email').value;
        document.getElementById('sentEmail').innerText = email;
        document.getElementById('completionModal').classList.remove('hidden');
    }

    window.onload = function() {
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        window.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e); });
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });
        canvas.addEventListener('touchend', stopDrawing);
        updateUI(); // Initial UI update
    };
</script>
</body>
</html>